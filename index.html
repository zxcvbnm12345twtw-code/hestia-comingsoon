<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HESTIA — Tone-on-Tone 首發色投票</title>
  <style>
    :root {
      --hue: 8; --sat: 92%; --lum: 54%;
      --tone-bg: hsl(var(--hue) 30% 10%);
      --tone-atm: hsl(var(--hue) 34% 12%);
      --tone-core: hsl(var(--hue) var(--sat) var(--lum));
      --tone-hi: hsl(var(--hue) 100% 68%);
      --uiText: rgba(255,255,255,.92);
      --uiTextMuted: rgba(255,255,255,.72);
      --uiStroke: rgba(255,255,255,.14);
      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
      --ease: cubic-bezier(.2,.8,.2,1);
      --ease2: cubic-bezier(.16,1,.3,1);
      --dur: 900ms;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0; background: #000; color: var(--uiText);
      font-family: system-ui, -apple-system, sans-serif;
      overflow: hidden; -webkit-font-smoothing: antialiased;
    }
    .app {
      height: 100vh; height: 100svh; position: relative;
      overflow-x: hidden; overflow-y: auto; scroll-snap-type: y mandatory;
      background:
        radial-gradient(1200px 900px at 18% 16%, color-mix(in oklab, var(--tone-core), white 12%) 0%, rgba(0,0,0,0) 56%),
        radial-gradient(900px 900px at 82% 28%, color-mix(in oklab, var(--tone-core), black 36%) 0%, rgba(0,0,0,0) 62%),
        linear-gradient(180deg, var(--tone-bg), var(--tone-atm) 42%, var(--tone-bg) 100%);
      transition: background 900ms var(--ease);
    }
    .topbar {
      position: fixed; top: calc(10px + var(--safeTop)); left: 20px; right: 20px;
      display: flex; justify-content: space-between; z-index: 100; pointer-events: none;
    }
    .chip {
      pointer-events: auto; background: rgba(0,0,0,.22); padding: 8px 16px; border-radius: 99px;
      border: 1px solid var(--uiStroke); backdrop-filter: blur(12px); font-size: 12px;
    }
    .stage {
      height: 100vh; height: 100svh; display: flex; align-items: center; justify-content: center;
      scroll-snap-align: start; transition: opacity 800ms;
    }
    .monolith { width: min(520px, 92vw); text-align: center; }
    .mark-wrap { margin: 0 auto; width: 240px; aspect-ratio: 1/1; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border: 1px solid var(--uiStroke); }
    .hestia-mark { width: 60%; height: auto; fill: #fff; transition: transform 0.5s; }
    .gate { margin-top: 30px; display: flex; flex-direction: column; gap: 12px; align-items: center; }
    .gate input { width: 300px; height: 48px; border-radius: 16px; border: 1px solid var(--uiStroke); background: rgba(0,0,0,0.2); color: #fff; padding: 0 16px; text-align: center; }
    .gate button { width: 300px; height: 48px; border-radius: 16px; background: var(--tone-core); color: #fff; border: none; font-weight: bold; cursor: pointer; }
    .spectrum { position: absolute; inset: 0; overflow-y: auto; scroll-snap-type: y mandatory; opacity: 0; pointer-events: none; }
    .spectrum.is-open { opacity: 1; pointer-events: auto; }
    .stall { height: 100vh; height: 100svh; scroll-snap-align: start; display: flex; align-items: center; justify-content: center; position: relative; }
    .chargeSquare { width: 260px; aspect-ratio: 1/1; border-radius: 24px; border: 1px solid var(--uiStroke); background: rgba(255,255,255,0.03); position: relative; overflow: hidden; cursor: pointer; }
    .sqFill { position: absolute; bottom: 0; left: 0; width: 0%; height: 100%; background: var(--tone-core); opacity: 0.3; transition: width 0.1s linear; }
    .confirm { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(20px); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.5s; }
    .confirm.is-on { opacity: 1; pointer-events: auto; }
    .panel { width: min(500px, 92vw); background: #111; border-radius: 32px; padding: 24px; text-align: center; border: 1px solid var(--uiStroke); }
    canvas { width: 100%; border-radius: 16px; margin: 20px 0; border: 1px solid #333; }
    .toast { position: fixed; top: 40px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 10px 20px; border-radius: 99px; z-index: 300; opacity: 0; transition: 0.3s; }
    .toast.on { opacity: 1; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="chip">HESTIA — <span id="phase">PRISM</span></div>
      <div class="chip" id="activeColorChip" style="opacity: 0;">Color: <b id="activeColorName">—</b></div>
    </div>

    <section class="stage" id="monolithStage">
      <div class="monolith">
        <div class="mark-wrap"><svg class="hestia-mark" viewBox="0 0 100 100"><path d="M50 10 L85 85 L50 65 L15 85 Z"/></svg></div>
        <h1 style="margin-top:20px; font-weight: 900; letter-spacing: 2px;">HESTIA</h1>
        <p style="color:var(--uiTextMuted);">首發色投票 · Tone-on-Tone</p>
        <div class="gate">
          <input id="gateEmail" type="email" placeholder="輸入你的 Email" />
          <button id="gateBtn">進入投票</button>
          <div id="gateWarn" style="color:red; font-size:12px; opacity:0;">請輸入正確 Email</div>
        </div>
      </div>
    </section>

    <main class="spectrum" id="spectrum">
      <section class="stall" data-key="ignition" data-en="IGNITION" data-zh="點燃紅" data-hue="8">
        <div class="monolith">
          <h2 style="font-size: 48px; margin: 0;">IGNITION</h2>
          <p>Option A · 點燃紅</p>
          <div class="chargeSquare" data-charge-square>
            <div class="sqFill" data-sq-fill></div>
            <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:12px; opacity:0.6;">長按一秒投票</div>
          </div>
        </div>
      </section>
      <section class="stall" data-key="momentum" data-en="MOMENTUM" data-zh="動能橙" data-hue="28">
        <div class="monolith">
          <h2 style="font-size: 48px; margin: 0;">MOMENTUM</h2>
          <p>Option B · 動能橙</p>
          <div class="chargeSquare" data-charge-square><div class="sqFill" data-sq-fill></div></div>
        </div>
      </section>
      <section class="stall" data-key="ground" data-en="GROUND" data-zh="著地綠" data-hue="132">
        <div class="monolith">
          <h2 style="font-size: 48px; margin: 0;">GROUND</h2>
          <p>Option C · 著地綠</p>
          <div class="chargeSquare" data-charge-square><div class="sqFill" data-sq-fill></div></div>
        </div>
      </section>
    </main>

    <section class="confirm" id="confirm">
      <div class="panel">
        <h2 id="confirmTitle">投票完成</h2>
        <p style="font-size:14px; color:var(--uiTextMuted);">您的專屬 Founder Card 已生成</p>
        <canvas id="cardCanvas" width="1200" height="750"></canvas>
        <div style="display:flex; gap:12px; justify-content:center;">
          <button id="downloadCard" style="padding:12px 24px; border-radius:12px; background:var(--tone-core); color:#fff; border:none; cursor:pointer;">下載卡片</button>
          <button id="closeConfirm" style="padding:12px 24px; border-radius:12px; background:#333; color:#fff; border:none; cursor:pointer;">關閉</button>
        </div>
      </div>
    </section>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    const WORLDS = [
      {key: "ignition", en: "IGNITION", zh: "點燃紅", h: 8, sat: 92, lum: 54, hex: "#F63B1E"},
      {key: "momentum", en: "MOMENTUM", zh: "動能橙", h: 28, sat: 92, lum: 54, hex: "#F6831E"},
      {key: "ground", en: "GROUND", zh: "著地綠", h: 132, sat: 78, lum: 46, hex: "#1AD13E"}
    ];

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    let userEmail = "";

    // 色彩切換邏輯
    function setTone(h, s, l) {
      document.documentElement.style.setProperty("--hue", h);
      document.documentElement.style.setProperty("--sat", s + "%");
      document.documentElement.style.setProperty("--lum", l + "%");
    }

    // Hero 頁面背景變色循環 [cite: 561]
    let cycleIdx = 0;
    const cycleTimer = setInterval(() => {
      if ($('#spectrum').classList.contains('is-open')) return;
      const w = WORLDS[cycleIdx % WORLDS.length];
      setTone(w.h, w.sat, w.lum);
      cycleIdx++;
    }, 2000);

    // Email 進入邏輯
    $('#gateBtn').addEventListener('click', () => {
      const email = $('#gateEmail').value;
      if (!email.includes('@')) { $('#gateWarn').style.opacity = 1; return; }
      userEmail = email;
      $('#monolithStage').style.opacity = 0;
      setTimeout(() => {
        $('#monolithStage').style.display = 'none';
        $('#spectrum').classList.add('is-open');
        $('#activeColorChip').style.opacity = 1;
        $('#phase').textContent = "SPECTRUM";
      }, 800);
    });

    // 投票長按 UX [cite: 568, 588]
    let holdTimer;
    $$('[data-charge-square]').forEach(sq => {
      const fill = sq.querySelector('[data-sq-fill]');
      sq.addEventListener('pointerdown', () => {
        fill.style.width = '100%';
        fill.style.transition = 'width 1s linear';
        holdTimer = setTimeout(() => {
          const world = WORLDS.find(w => w.key === sq.closest('.stall').dataset.key);
          showResult(world);
        }, 1000);
      });
      sq.addEventListener('pointerup', () => {
        clearTimeout(holdTimer);
        fill.style.transition = 'width 0.2s ease-out';
        fill.style.width = '0%';
      });
    });

    // 結果與卡片生成 [cite: 511, 614]
    function showResult(w) {
      const canvas = $('#cardCanvas');
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = w.hex;
      ctx.fillRect(0, 0, 1200, 750);
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.font = "bold 80px sans-serif";
      ctx.fillText("FOUNDER CARD", 80, 150);
      ctx.font = "120px sans-serif";
      ctx.fillText(w.en, 80, 400);
      ctx.font = "40px sans-serif";
      ctx.fillText(userEmail, 80, 650);
      $('#confirm').classList.add('is-on');
    }

    // 修正：修正原本可能導致崩潰的監聽器引用 [cite: 617, 618]
    $('#closeConfirm').addEventListener('click', () => $('#confirm').classList.remove('is-on'));
    $('#downloadCard').addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = `HESTIA-Founder-${userEmail}.png`;
      link.href = $('#cardCanvas').toDataURL();
      link.click();
    });

    // 滾動切換背景色 [cite: 566]
    $('#spectrum').addEventListener('scroll', () => {
      const idx = Math.round($('#spectrum').scrollTop / window.innerHeight);
      const w = WORLDS[idx];
      if (w) {
        setTone(w.h, w.sat, w.lum);
        $('#activeColorName').textContent = w.en;
      }
    });
  </script>
</body>
</html>
