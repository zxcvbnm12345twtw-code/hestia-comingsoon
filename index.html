<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HESTIA｜Tone-on-Tone 投票</title>
  <meta name="description" content="選出你最喜歡的 Tone-on-Tone 色彩世界。" />
  <style>
    :root {
      --bg1: #2a1212;
      --bg2: #4a1b14;
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --radius: 22px;
      --ease: cubic-bezier(.2,.8,.2,1);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      color: var(--txt);
      overflow-x: hidden;
      background: #0b0b0c;
    }

    /* ===== Background crossfade (true gradient fade, not a hard switch) ===== */
    .bg {
      position: fixed;
      inset: 0;
      z-index: -2;
      overflow: hidden;
    }
    .bg::before,
    .bg::after {
      content: "";
      position: absolute;
      inset: -20%;
      transform: translateZ(0);
      transition: opacity 900ms var(--ease);
    }
    .bg::before {
      opacity: 1;
      background: radial-gradient(1200px 700px at 20% 15%, rgba(255,255,255,.10), transparent 55%),
                  linear-gradient(135deg, var(--bg1), var(--bg2));
    }
    .bg::after {
      opacity: 0;
      background: radial-gradient(1200px 700px at 20% 15%, rgba(255,255,255,.10), transparent 55%),
                  linear-gradient(135deg, var(--bg1n, var(--bg1)), var(--bg2n, var(--bg2)));
    }
    body.is-shifting .bg::before { opacity: 0; }
    body.is-shifting .bg::after  { opacity: 1; }

    .grain {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      opacity: .085;
      mix-blend-mode: overlay;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.5'/%3E%3C/svg%3E");
      background-size: 220px 220px;
    }

    /* Disable selection to avoid long-press highlighting */
    .no-select, .no-select * {
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .wrap {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 28px 18px 54px;
    }

    .shell {
      width: min(980px, 100%);
      display: grid;
      gap: 16px;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow: hidden;
    }

    .hero { padding: 22px 18px; }
    .hero-inner {
      display: grid;
      gap: 14px;
      justify-items: center;
      text-align: center;
    }

    .hestia-mark {
      width: clamp(44px, 7vw, 68px);
      height: auto;
      color: rgba(255,255,255,.92);
      transition: color 900ms var(--ease), transform 900ms var(--ease), opacity 900ms var(--ease);
      opacity: 0;
      transform: translateY(6px) scale(.98);
    }
    body.is-ready .hestia-mark {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .kicker {
      font-size: 12px;
      letter-spacing: .24em;
      text-transform: uppercase;
      color: rgba(255,255,255,.70);
    }

    h1 {
      margin: 0;
      font-size: clamp(22px, 4.2vw, 34px);
      line-height: 1.1;
      letter-spacing: .01em;
    }

    .sub {
      margin: 0;
      color: rgba(255,255,255,.62);
      font-size: 14px;
      line-height: 1.6;
      max-width: 60ch;
    }

    .gate {
      padding: 18px;
      display: grid;
      gap: 12px;
    }

    .field { display: grid; gap: 8px; }
    label { font-size: 13px; color: rgba(255,255,255,.78); }

    input[type="email"] {
      width: 100%;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      outline: none;
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      font-size: 15px;
      transition: border-color 250ms var(--ease), transform 250ms var(--ease);
    }
    input[type="email"]::placeholder { color: rgba(255,255,255,.48); }
    input[type="email"]:focus {
      border-color: rgba(255,255,255,.34);
      transform: translateY(-1px);
    }

    .row { display: grid; gap: 10px; }
    @media (min-width: 720px) {
      .row { grid-template-columns: 1fr auto; align-items: end; }
    }

    .btn {
      border: 0;
      border-radius: 14px;
      padding: 13px 16px;
      cursor: pointer;
      font-weight: 650;
      letter-spacing: .02em;
      color: rgba(255,255,255,.92);
      background: rgba(255,255,255,.16);
      transition: transform 220ms var(--ease), background 220ms var(--ease), opacity 220ms var(--ease);
      white-space: nowrap;
    }
    .btn:hover { transform: translateY(-1px); background: rgba(255,255,255,.20); }
    .btn:active { transform: translateY(0px) scale(.99); }
    .btn[disabled] { opacity: .45; cursor: not-allowed; transform: none; }

    .note { font-size: 12.5px; color: rgba(255,255,255,.62); line-height: 1.55; }

    /* ===== Voting ===== */
    .vote { padding: 18px; display: none; gap: 14px; }
    body.is-voting .vote { display: grid; }
    body.is-voting .gate { display: none; }

    .hint {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      color: rgba(255,255,255,.72);
      font-size: 12.5px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    @media (min-width: 720px) {
      .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    .tone {
      position: relative;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      padding: 14px;
      min-height: 110px;
      cursor: pointer;
      transform: translateZ(0);
      transition: transform 220ms var(--ease), border-color 220ms var(--ease);
    }
    .tone:hover { transform: translateY(-2px); border-color: rgba(255,255,255,.24); }
    .tone:active { transform: translateY(0px) scale(.995); }

    .tone .swatch {
      position: absolute;
      inset: 0;
      opacity: .92;
      background: linear-gradient(135deg, var(--c1), var(--c2));
      transform: scale(1.08);
      filter: saturate(1.02);
    }
    .tone .overlay {
      position: absolute;
      inset: 0;
      background:
        radial-gradient(500px 220px at 15% 15%, rgba(255,255,255,.22), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.00), rgba(0,0,0,.35));
      pointer-events: none;
    }
    .tone .meta { position: relative; z-index: 1; display: grid; gap: 8px; }
    .tone .name { font-weight: 720; letter-spacing: .04em; font-size: 14px; }
    .tone .desc { font-size: 12.5px; color: rgba(255,255,255,.80); line-height: 1.45; }

    /* Long-press energy fill */
    .tone .press {
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 12px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      overflow: hidden;
      z-index: 2;
    }
    .tone .press > i {
      display: block;
      height: 100%;
      width: 100%;
      transform: translateX(-100%);
      background: rgba(255,255,255,.78);
      border-radius: 999px;
    }
    .tone.is-pressing .press > i { animation: fill 1000ms linear forwards; }
    @keyframes fill { to { transform: translateX(0%); } }

    .tone.is-picked {
      border-color: rgba(255,255,255,.42);
      transform: translateY(-2px) scale(1.02);
    }

    @keyframes pop {
      0% { transform: translateY(-2px) scale(1.02); }
      60% { transform: translateY(-2px) scale(1.06); }
      100% { transform: translateY(-2px) scale(1.02); }
    }
    .tone.did-confirm { animation: pop 420ms var(--ease); }

    /* ===== Completion ===== */
    .done { padding: 18px; display: none; }
    body.is-done .done { display: grid; }
    body.is-done .vote { display: none; }
    body.is-done .gate { display: none; }

    .done-inner {
      display: grid;
      gap: 14px;
      justify-items: center;
      text-align: center;
      padding-top: 6px;
    }

    .result-card {
      width: min(620px, 100%);
      border-radius: 22px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      transform: translateY(-6px) scale(1.02);
    }

    .result-top { padding: 18px 18px 14px; display: grid; gap: 10px; }

    .result-swatch {
      height: 120px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, var(--rc1), var(--rc2));
      position: relative;
      overflow: hidden;
    }
    .result-swatch::after {
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(550px 220px at 20% 20%, rgba(255,255,255,.22), transparent 60%);
    }

    .done h2 { margin: 0; font-size: 18px; letter-spacing: .02em; }
    .done p  { margin: 0; color: rgba(255,255,255,.70); line-height: 1.6; font-size: 13.5px; }

    .mini {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,.72);
      font-size: 12.5px;
      flex-wrap: wrap;
    }

    .pill {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
    }

    .error { color: rgba(255,220,220,.92); font-size: 12.5px; display: none; }
    .error.show { display: block; }

    .ok { color: rgba(220,255,236,.92); font-size: 12.5px; display: none; }
    .ok.show { display: block; }

    @media (prefers-reduced-motion: reduce) {
      .bg::before, .bg::after, .btn, .tone, .hestia-mark { transition: none !important; }
      .tone.is-pressing .press > i { animation: none !important; transform: translateX(0%) !important; }
    }
  </style>
</head>

<body class="no-select">
  <div class="bg" aria-hidden="true"></div>
  <div class="grain" aria-hidden="true"></div>

  <main class="wrap">
    <div class="shell">
      <section class="card hero">
        <div class="hero-inner">
          <svg class="hestia-mark" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 377.947 377.947"><defs><clipPath id="hestia-clip" clipPathUnits="userSpaceOnUse"><path d="M0 283.46h283.46V0H0Z"/></clipPath></defs><g clip-path="url(#hestia-clip)" transform="matrix(1.33333 0 0 -1.33333 0 377.947)"><path d="m0 0 .021 30.904v21.16c1.7-.726 2.874-1.347 3.741-1.975 13.229-9.61 26.525-19.134 39.59-28.963 8.824-6.639 11.979-15.609 12.006-26.809v-53.709c-1.7.726-2.895 1.347-3.762 1.976-13.229 9.61-26.525 19.133-39.59 28.963C3.182-21.815.048-12.845.021-1.645V0z" fill="currentColor" fill-rule="nonzero" transform="translate(192.76 80.98)"/><path d="M0 0c-.002 40.944 0 .466 0 41.447-.744 43.582-46.129 81.844-106.34 81.844s-105.597-38.262-106.341-81.844c0-40.981.002-.503 0-41.447 0-6.713-.047-13.786-.047-21.213 1.701.727 2.882 1.348 3.749 1.977 13.229 9.61 26.525 19.132 39.59 28.962 8.824 6.639 11.958 15.609 11.985 26.809v.036l.029 27.898c0 30.598 19.233 55.105 51.035 55.105s51.034-24.507 51.034-55.105l.029-27.934c.027-11.2 3.161-20.17 11.985-26.809 13.065-9.83 26.361-19.352 39.59-28.962.867-.629 2.049-1.25 3.749-1.977C.047-13.786 0-6.713 0 0" fill="currentColor" fill-rule="nonzero" transform="translate(248.07 131.631)"/><path d="M0 0v52.064c-1.7-.726-2.874-1.347-3.741-1.975-13.229-9.61-26.525-19.134-39.59-28.963-8.824-6.639-11.979-15.609-12.006-26.809v-53.709c1.7.726 2.895 1.347 3.762 1.976 13.229 9.61 26.525 19.133 39.59 28.963C-3.161-21.815-.027-12.845 0-1.645z" fill="currentColor" fill-rule="nonzero" transform="translate(90.68 80.98)"/></g></svg>
          <div class="kicker">TONE-ON-TONE</div>
          <h1>投出你心中的色彩氣場</h1>
          <p class="sub">請先留下 Email 才能進入投票。進入後，長按 1 秒完成選擇（會有能量注滿的感覺）。</p>
        </div>
      </section>

      <!-- ===== Email Gate (must-fill) ===== -->
      <section class="card gate" id="gate">
        <div class="row">
          <div class="field">
            <label for="email">Email（必填）</label>
            <input id="email" type="email" autocomplete="email" placeholder="name@example.com" required />
            <div class="error" id="gateError">請輸入有效 Email，才能進入投票。</div>
            <div class="error" id="onceError">這個 Email 已完成投票，感謝你。</div>
            <div class="ok" id="gateOk">完成！已進入投票。</div>
          </div>
          <button class="btn" id="enterBtn" type="button">進入投票</button>
        </div>
        <div class="note">
          ※ 每個 Email 只能參與一次。<br/>
          ※ 目前先以「本機防重複（localStorage）」執行；之後可再串接 Google 表單 / 試算表做雲端比對。
        </div>
      </section>

      <!-- ===== Voting ===== -->
      <section class="card vote" id="vote">
        <div class="hint">
          <span>長按 1 秒完成投票</span>
          <span id="who" class="pill" title="目前投票 Email"></span>
        </div>

        <div class="grid" id="grid" aria-label="色彩投票選項">
          <button class="tone" type="button" data-tone="red" data-c1="#B92A2A" data-c2="#F06A5A">
            <span class="swatch" style="--c1:#B92A2A;--c2:#F06A5A"></span>
            <span class="overlay"></span>
            <span class="meta">
              <span class="name">紅</span>
              <span class="desc">熱度上場，氣場直接。</span>
            </span>
            <span class="press" aria-hidden="true"><i></i></span>
          </button>

          <button class="tone" type="button" data-tone="orange" data-c1="#D6502D" data-c2="#FF9B3D">
            <span class="swatch" style="--c1:#D6502D;--c2:#FF9B3D"></span>
            <span class="overlay"></span>
            <span class="meta">
              <span class="name">橙</span>
              <span class="desc">溫暖推進，亮點剛好。</span>
            </span>
            <span class="press" aria-hidden="true"><i></i></span>
          </button>

          <button class="tone" type="button" data-tone="green" data-c1="#1F6E55" data-c2="#66C7A6">
            <span class="swatch" style="--c1:#1F6E55;--c2:#66C7A6"></span>
            <span class="overlay"></span>
            <span class="meta">
              <span class="name">綠</span>
              <span class="desc">沉住節奏，柔和續航。</span>
            </span>
            <span class="press" aria-hidden="true"><i></i></span>
          </button>

          <button class="tone" type="button" data-tone="blue" data-c1="#224B7A" data-c2="#7DA7FF">
            <span class="swatch" style="--c1:#224B7A;--c2:#7DA7FF"></span>
            <span class="overlay"></span>
            <span class="meta">
              <span class="name">藍</span>
              <span class="desc">乾淨冷靜，定向前行。</span>
            </span>
            <span class="press" aria-hidden="true"><i></i></span>
          </button>

          <button class="tone" type="button" data-tone="purple" data-c1="#4A2A6A" data-c2="#B48BFF">
            <span class="swatch" style="--c1:#4A2A6A;--c2:#B48BFF"></span>
            <span class="overlay"></span>
            <span class="meta">
              <span class="name">紫</span>
              <span class="desc">層次收斂，質感上升。</span>
            </span>
            <span class="press" aria-hidden="true"><i></i></span>
          </button>

          <button class="tone" type="button" data-tone="brown" data-c1="#3B2A21" data-c2="#B58A66">
            <span class="swatch" style="--c1:#3B2A21;--c2:#B58A66"></span>
            <span class="overlay"></span>
            <span class="meta">
              <span class="name">咖</span>
              <span class="desc">安定落點，耐看不吵。</span>
            </span>
            <span class="press" aria-hidden="true"><i></i></span>
          </button>
        </div>

        <div class="note" id="voteNote">
          選定後會立即送出並顯示完成頁。若之後要改成「送出前確認一次」，我也可以幫你加一個確認步驟。
        </div>
      </section>

      <!-- ===== Done ===== -->
      <section class="card done" id="done">
        <div class="done-inner">
          <div class="mini">
            <span class="pill">已完成投票</span>
            <span id="doneEmail" class="pill"></span>
          </div>

          <div class="result-card">
            <div class="result-top">
              <div class="result-swatch" id="resultSwatch" style="--rc1:#B92A2A;--rc2:#F06A5A"></div>
              <h2 id="doneTitle">你選擇了：紅</h2>
              <p id="doneDesc">謝謝你把氣場投給這個世界。你的選擇會成為 HESTIA 的下一步。</p>
            </div>
          </div>

          <button class="btn" id="resetBtn" type="button" style="background: rgba(255,255,255,.12)">我想換一個 Email 再投</button>
          <div class="note">（此按鈕只會清除本機記錄；若未來串接雲端防重複，仍會以雲端為準。）</div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));

    const TONES = {
      red:    { bg1: "#2a1212", bg2: "#6a1b16" },
      orange: { bg1: "#24150f", bg2: "#7a3514" },
      green:  { bg1: "#0f1d17", bg2: "#1f5c48" },
      blue:   { bg1: "#0f1622", bg2: "#253a66" },
      purple: { bg1: "#161022", bg2: "#4a2a6a" },
      brown:  { bg1: "#16110f", bg2: "#4a2f1f" },
    };

    function shiftBackground(toneKey) {
      const t = TONES[toneKey];
      if (!t) return;

      document.documentElement.style.setProperty("--bg1n", t.bg1);
      document.documentElement.style.setProperty("--bg2n", t.bg2);

      document.body.classList.add("is-shifting");
      window.clearTimeout(shiftBackground._timer);
      shiftBackground._timer = window.setTimeout(() => {
        document.documentElement.style.setProperty("--bg1", t.bg1);
        document.documentElement.style.setProperty("--bg2", t.bg2);
        document.body.classList.remove("is-shifting");
      }, 940);
    }

    const LS_KEY   = "hestia_vote_email_hash_v1";
    const LS_EMAIL = "hestia_vote_email_plain_v1"; // display only
    const LS_VOTE  = "hestia_vote_pick_v1";

    async function sha256(text) {
      const enc = new TextEncoder();
      const data = enc.encode(text.trim().toLowerCase());
      if (window.crypto?.subtle) {
        const digest = await crypto.subtle.digest("SHA-256", data);
        return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, "0")).join("");
      }
      let h = 0;
      for (const c of text) h = Math.imul(31, h) + c.charCodeAt(0) | 0;
      return "fh_" + (h >>> 0).toString(16);
    }

    function isValidEmail(v) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim());
    }

    const els = {
      email: $("#email"),
      enterBtn: $("#enterBtn"),
      gateError: $("#gateError"),
      onceError: $("#onceError"),
      gateOk: $("#gateOk"),
      who: $("#who"),
      doneEmail: $("#doneEmail"),
      doneTitle: $("#doneTitle"),
      doneDesc: $("#doneDesc"),
      resultSwatch: $("#resultSwatch"),
      resetBtn: $("#resetBtn"),
      tones: $$(".tone"),
    };

    let currentEmail = "";
    let pressTimer = null;
    let pressedEl = null;

    function show(el, on=true) { el.classList.toggle("show", !!on); }

    function setState(state) {
      document.body.classList.remove("is-voting", "is-done");
      if (state === "voting") document.body.classList.add("is-voting");
      if (state === "done")   document.body.classList.add("is-done");
    }

    function maskEmail(email) {
      const [u, d] = (email || "").split("@");
      if (!d) return email || "";
      const u2 = u.length <= 2 ? u[0] + "*" : u.slice(0,1) + "*".repeat(Math.max(1, u.length-2)) + u.slice(-1);
      return u2 + "@" + d;
    }

    async function enterVoting() {
      show(els.gateError, false);
      show(els.onceError, false);
      show(els.gateOk, false);

      const email = els.email.value.trim();
      if (!isValidEmail(email)) {
        show(els.gateError, true);
        return;
      }

      const hash = await sha256(email);
      const existing = localStorage.getItem(LS_KEY);

      // One email one vote (local). If you want one-device-one-vote, change to: if (existing) block.
      if (existing && existing === hash) {
        show(els.onceError, true);
        return;
      }

      currentEmail = email;
      els.who.textContent = "Email：" + maskEmail(email);

      localStorage.setItem(LS_KEY, hash);
      localStorage.setItem(LS_EMAIL, email);

      setState("voting");
      show(els.gateOk, true);

      shiftBackground("red");
      requestAnimationFrame(() => {
        document.getElementById("vote")?.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    }

    function clearPressState(el) {
      if (!el) return;
      el.classList.remove("is-pressing");
      const bar = el.querySelector(".press > i");
      if (bar) {
        const clone = bar.cloneNode(true);
        bar.parentNode.replaceChild(clone, bar);
      }
    }

    function setPicked(el) {
      els.tones.forEach(t => t.classList.remove("is-picked", "did-confirm"));
      el.classList.add("is-picked", "did-confirm");
    }

    function donePage(pick) {
      shiftBackground(pick.tone);

      els.resultSwatch.style.setProperty("--rc1", pick.c1);
      els.resultSwatch.style.setProperty("--rc2", pick.c2);
      els.doneTitle.textContent = "你選擇了：" + pick.name;
      els.doneDesc.textContent = "謝謝你把氣場投給這個世界。你的選擇會成為 HESTIA 的下一步。";
      els.doneEmail.textContent = "Email：" + maskEmail(currentEmail || (localStorage.getItem(LS_EMAIL) || ""));

      setState("done");
      document.getElementById("done")?.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    async function submitVote(pick) {
      localStorage.setItem(LS_VOTE, JSON.stringify({
        email: currentEmail,
        tone: pick.tone,
        c1: pick.c1,
        c2: pick.c2,
        ts: Date.now()
      }));

      // Placeholder: replace with Google Form / Apps Script endpoint later.
      // await fetch("YOUR_ENDPOINT", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ email: currentEmail, tone: pick.tone }) });

      donePage(pick);
    }

    function attachLongPress() {
      const PRESS_MS = 1000;

      const start = (el) => {
        if (!currentEmail) return;
        pressedEl = el;
        clearPressState(el);
        el.classList.add("is-pressing");

        // soft preview
        shiftBackground(el.dataset.tone);

        pressTimer = window.setTimeout(() => {
          clearPressState(el);
          setPicked(el);

          const pick = {
            tone: el.dataset.tone,
            c1: el.dataset.c1,
            c2: el.dataset.c2,
            name: el.querySelector(".name")?.textContent?.trim() || el.dataset.tone,
          };
          submitVote(pick);
        }, PRESS_MS);
      };

      const cancel = () => {
        window.clearTimeout(pressTimer);
        pressTimer = null;
        if (pressedEl) {
          clearPressState(pressedEl);
          pressedEl = null;
        }
      };

      els.tones.forEach(el => {
        el.addEventListener("pointerdown", (e) => {
          e.preventDefault();
          el.setPointerCapture?.(e.pointerId);
          start(el);
        }, { passive: false });

        el.addEventListener("pointerup", (e) => { e.preventDefault(); cancel(); }, { passive: false });
        el.addEventListener("pointercancel", cancel);
        el.addEventListener("pointerleave", cancel);
        el.addEventListener("contextmenu", (e) => e.preventDefault());
      });
    }

    function bootFromStorage() {
      const pickRaw = localStorage.getItem(LS_VOTE);
      const email = localStorage.getItem(LS_EMAIL) || "";
      if (pickRaw) {
        try {
          const pick = JSON.parse(pickRaw);
          currentEmail = pick.email || email;
          if (currentEmail) {
            donePage({
              tone: pick.tone || "red",
              c1: pick.c1 || "#B92A2A",
              c2: pick.c2 || "#F06A5A",
              name: ({red:"紅",orange:"橙",green:"綠",blue:"藍",purple:"紫",brown:"咖"})[pick.tone] || "已投票"
            });
            return true;
          }
        } catch (_) {}
      }
      return false;
    }

    els.enterBtn.addEventListener("click", enterVoting);
    els.email.addEventListener("keydown", (e) => { if (e.key === "Enter") enterVoting(); });
    els.resetBtn.addEventListener("click", () => {
      localStorage.removeItem(LS_KEY);
      localStorage.removeItem(LS_EMAIL);
      localStorage.removeItem(LS_VOTE);
      location.reload();
    });

    window.addEventListener("load", () => {
      document.body.classList.add("is-ready");
      shiftBackground("red");
      attachLongPress();

      const restored = bootFromStorage();
      if (!restored) setState("gate");
    });
  </script>
</body>
</html>
